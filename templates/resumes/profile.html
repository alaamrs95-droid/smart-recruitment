<!-- templates/resumes/profile.html -->
<!-- تم إنشاء هذا القالب لعرض وإدارة ملف تعريف السيرة الذاتية -->
{% extends "base/base.html" %}
{% load static i18n custom_filters %}

{% block title %}{% trans "Resume Profile" %} - منصة توظيف ذكية{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mt-3">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user-circle mr-2"></i>{% trans "My Resume Profile" %}
                    </h3>
                    <div class="card-tools">
                        <div class="btn-group">
                            <a href="{% url 'resumes:upload' %}" class="btn btn-sm btn-info">
                                <i class="fas fa-upload mr-1"></i>{% trans "Upload Resume" %}
                            </a>
                            <a href="{% url 'resumes_builder:resume_list' %}" class="btn btn-sm btn-success">
                                <i class="fas fa-edit mr-1"></i>{% trans "Build Resume" %}
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    {% if has_resume %}
                    <!-- معلومات الملف الشخصي -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-box">
                                <span class="info-box-icon bg-info"><i class="fas fa-file-alt"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">{% trans "Primary Resume Type" %}</span>
                                    <span class="info-box-number">
                                        {% if profile.primary_resume_type == 'built' %}
                                            {% trans "Built Resume" %}
                                        {% elif profile.primary_resume_type == 'uploaded' %}
                                            {% trans "Uploaded Resume" %}
                                        {% else %}
                                            {% trans "Both Resumes" %}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="info-box">
                                <span class="info-box-icon {% if profile.is_active_for_matching %}bg-success{% else %}bg-warning{% endif %}">
                                    <i class="fas fa-search"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">{% trans "Matching Status" %}</span>
                                    <span class="info-box-number">
                                        {% if profile.is_active_for_matching %}
                                            {% trans "Active" %}
                                        {% else %}
                                            {% trans "Inactive" %}
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- السير الذاتية المتاحة -->
                    <div class="row">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-list mr-2"></i>{% trans "My Resumes" %}
                            </h5>
                            
                            {% for resume_info in all_resumes %}
                            <div class="card mb-3 {% if resume_info.is_primary %}border-primary{% endif %}">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">
                                            {% if resume_info.type == 'built' %}
                                                <i class="fas fa-edit text-success mr-2"></i>
                                                {% trans "Built Resume" %}
                                            {% else %}
                                                <i class="fas fa-file-upload text-info mr-2"></i>
                                                {% trans "Uploaded Resume" %}
                                            {% endif %}
                                            
                                            {% if resume_info.is_primary %}
                                                <span class="badge badge-primary ml-2">{% trans "Primary" %}</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ resume_info.title }}</small>
                                    </div>
                                    
                                    <div class="btn-group">
                                        {% if resume_info.type == 'built' %}
                                            <a href="{{ resume_info.resume.get_absolute_url }}" 
                                               class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-eye mr-1"></i>{% trans "View" %}
                                            </a>
                                        {% else %}
                                            <a href="{{ resume_info.resume.get_absolute_url }}" 
                                               class="btn btn-sm btn-outline-info" target="_blank">
                                                <i class="fas fa-download mr-1"></i>{% trans "Download" %}
                                            </a>
                                        {% endif %}
                                        
                                        {% if not resume_info.is_primary %}
                                            <button class="btn btn-sm btn-outline-primary set-primary-btn" 
                                                    data-type="{{ resume_info.type }}">
                                                <i class="fas fa-star mr-1"></i>{% trans "Set as Primary" %}
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- إعدادات إضافية -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="mb-3">
                                <i class="fas fa-cog mr-2"></i>{% trans "Settings" %}
                            </h5>
                            
                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" 
                                           id="matching-toggle" 
                                           {% if profile.is_active_for_matching %}checked{% endif %}>
                                    <label class="custom-control-label" for="matching-toggle">
                                        {% trans "Enable matching for employers" %}
                                    </label>
                                    <small class="form-text text-muted">
                                        {% trans "When enabled, employers can see your resume in their matches" %}
                                    </small>
                                </div>
                            </div>
                            
                            {% if has_both_resumes %}
                            <div class="form-group">
                                <label for="primary-type">{% trans "Primary Resume Type" %}</label>
                                <select class="form-control" id="primary-type">
                                    <option value="uploaded" {% if profile.primary_resume_type == 'uploaded' %}selected{% endif %}>
                                        {% trans "Uploaded Resume" %}
                                    </option>
                                    <option value="built" {% if profile.primary_resume_type == 'built' %}selected{% endif %}>
                                        {% trans "Built Resume" %}
                                    </option>
                                    <option value="both" {% if profile.primary_resume_type == 'both' %}selected{% endif %}>
                                        {% trans "Both (Prioritize Built)" %}
                                    </option>
                                </select>
                                <small class="form-text text-muted">
                                    {% trans "Choose which resume type employers see first in matching" %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% else %}
                    <!-- لا توجد سير ذاتية -->
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-4x text-muted mb-4"></i>
                        <h4>{% trans "No Resume Found" %}</h4>
                        <p class="text-muted mb-4">
                            {% trans "You don't have any resume yet. Create or upload a resume to get started." %}
                        </p>
                        <div class="btn-group">
                            <a href="{% url 'resumes:upload' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-upload mr-2"></i>{% trans "Upload Resume" %}
                            </a>
                            <a href="{% url 'resumes_builder:resume_list' %}" class="btn btn-success btn-lg">
                                <i class="fas fa-edit mr-2"></i>{% trans "Build Resume" %}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تبديل حالة المطابقة
    const matchingToggle = document.getElementById('matching-toggle');
    if (matchingToggle) {
        matchingToggle.addEventListener('change', function() {
            fetch('{% url "resumes_profile:toggle_matching" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // تحديث الواجهة
                    const infoBox = matchingToggle.closest('.info-box');
                    const icon = infoBox.querySelector('.info-box-icon');
                    const text = infoBox.querySelector('.info-box-number');
                    
                    if (data.is_active) {
                        icon.className = 'info-box-icon bg-success';
                        text.textContent = '{% trans "Active" %}';
                    } else {
                        icon.className = 'info-box-icon bg-warning';
                        text.textContent = '{% trans "Inactive" %}';
                    }
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('{% trans "An error occurred" %}', 'error');
            });
        });
    }
    
    // تعيين السيرة الذاتية الرئيسية
    const setPrimaryButtons = document.querySelectorAll('.set-primary-btn');
    setPrimaryButtons.forEach(button => {
        button.addEventListener('click', function() {
            const resumeType = this.dataset.type;
            
            fetch(`{% url "resumes_profile:set_primary" resume_type="TYPE" %}`.replace('TYPE', resumeType), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // إعادة تحميل الصفحة لتحديث الواجهة
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showMessage(data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('{% trans "An error occurred" %}', 'error');
            });
        });
    });
    
    // تغيير نوع السيرة الذاتية الرئيسية
    const primaryTypeSelect = document.getElementById('primary-type');
    if (primaryTypeSelect) {
        primaryTypeSelect.addEventListener('change', function() {
            const selectedType = this.value;
            
            fetch(`{% url "resumes_profile:set_primary" resume_type="TYPE" %}`.replace('TYPE', selectedType), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.error, 'error');
                    // إعادة القيمة الأصلية
                    this.value = '{{ profile.primary_resume_type }}';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('{% trans "An error occurred" %}', 'error');
                this.value = '{{ profile.primary_resume_type }}';
            });
        });
    }
});

// دالة مساعدة للحصول على CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// دالة مساعدة لعرض الرسائل
function showMessage(message, type) {
    // إزالة الرسائل القديمة
    const oldAlerts = document.querySelectorAll('.alert');
    oldAlerts.forEach(alert => alert.remove());
    
    // إنشاء رسالة جديدة
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    // إضافة الرسالة في أعلى الصفحة
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // إزالة الرسالة تلقائياً بعد 5 ثواني
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
